<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Dashboard de TI</title>
    <link rel="icon" type="image/jpeg" href="logo_empresa.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-green-dark: #166534;
            --brand-green-light: #22c55e;
            --glow-color: rgba(34, 197, 94, 0.5);
            --bg-color: #2B652E;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(34, 197, 94, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 90%, rgba(22, 101, 52, 0.2) 0%, transparent 40%);
            min-height: 100vh;
            color: #f3f4f6;
            transition: background-color 0.3s ease;
        }

        .glass-card {
            background-color: rgba(24, 24, 27, 0.5);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem; padding: 1.5rem;
            position: relative; overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .glass-card::before {
            content: ''; position: absolute;
            width: 150px; height: 150px; border-radius: 50%;
            background: var(--glow-color); filter: blur(80px);
            opacity: 0; transition: opacity 0.5s ease;
            top: var(--y, 0); left: var(--x, 0);
            transform: translate(-50%, -50%); pointer-events: none;
        }
        .glass-card:hover::before { opacity: 1; }

        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-on-load { opacity: 0; animation-fill-mode: forwards; animation-name: slideInUp; animation-duration: 0.6s; animation-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        #editPanel { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #editPanel.open { transform: translateX(0); }
        #editPanel::-webkit-scrollbar { width: 6px; }
        #editPanel::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        #editPanel::-webkit-scrollbar-thumb { background: rgba(34, 197, 94, 0.6); border-radius: 3px; }

        /* Estilo para placeholders */
        ::placeholder {
            color: #f3f4f6; /* cinza-claro (quase branco) */
            opacity: 1; /* Firefox */
        }
        ::-ms-input-placeholder { /* Internet Explorer 10-11 */
           color: #f3f4f6;
        }
        ::placeholder { /* Microsoft Edge */
           color: #f3f4f6;
        }

        Chart.defaults.color = '#FFFFFF'; /* Cor branca para todo o texto do gráfico */
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.legend.labels.boxWidth = 12; 
        Chart.defaults.plugins.legend.labels.padding = 15;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(10, 10, 10, 0.8)'; 
        Chart.defaults.plugins.tooltip.backdropFilter = 'blur(5px)';
        Chart.defaults.plugins.tooltip.padding = 12; 
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.animation.duration = 1000; 
        Chart.defaults.animation.easing = 'easeInOutQuart';
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <main id="dashboardContent">
            <header class="mb-8 flex items-center gap-4 animate-on-load" style="animation-delay: 100ms;">
                <img id="companyLogo" src="logo_empresa.jpeg" alt="Logo da Empresa" class="h-12 w-auto rounded-md shadow-lg">
                <div>
                     <h1 class="text-3xl font-extrabold text-white tracking-tight">Sistemas Ativos - Governança de TI</h1>
                </div>
            </header>

            <!-- Linha 1: KPIs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="glass-card animate-on-load" style="animation-delay: 200ms;"><h2 class="text-lg font-semibold text-white">Total de Sistemas</h2><p id="totalSistemas" class="text-4xl font-bold text-white mt-2">0</p></div>
                <div class="glass-card animate-on-load" style="animation-delay: 300ms;"><h2 class="text-lg font-semibold text-white">Total de Fornecedores</h2><p id="totalFornecedores" class="text-4xl font-bold text-white mt-2">0</p></div>
                <div class="glass-card animate-on-load" style="animation-delay: 400ms;"><h2 class="text-lg font-semibold text-white">Total de Departamentos</h2><p id="totalDepartamentos" class="text-4xl font-bold text-white mt-2">0</p></div>
            </div>

            <!-- Linha 2: Gráficos de Contagem -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="glass-card lg:col-span-2 animate-on-load" style="animation-delay: 600ms;"><h3 class="text-xl font-semibold mb-4 text-center">Sistemas por Departamento</h3><canvas id="departmentChart"></canvas></div>
                <div class="glass-card lg:col-span-3 animate-on-load" style="animation-delay: 700ms;"><h3 class="text-xl font-semibold mb-4 text-center">Sistemas por Fornecedor</h3><div class="h-80 sm:h-96"><canvas id="vendorChart"></canvas></div></div>
            </div>

            <!-- LINHA 3: GRÁFICOS DE CUSTO -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="glass-card lg:col-span-3 animate-on-load" style="animation-delay: 800ms;"><h3 id="monthlyCostChartTitle" class="text-xl font-semibold mb-4 text-center">Evolução de Custo Mensal</h3><div class="h-80 sm:h-96"><canvas id="monthlyCostChart"></canvas></div></div>
                <div class="glass-card lg:col-span-2 animate-on-load" style="animation-delay: 900ms;"><h3 class="text-xl font-semibold mb-4 text-center">Custo Anual por Departamento</h3><canvas id="departmentCostChart"></canvas></div>
            </div>

            <!-- LINHA 4: GRÁFICO COMPARADOR DE FORNECEDOR -->
            <div class="glass-card animate-on-load mb-8" style="animation-delay: 950ms;">
                <h3 class="text-xl font-semibold mb-4 text-center">Comparador de Custo Mensal por Fornecedor</h3>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Lista de Checkbox -->
                    <div class="lg:col-span-1 h-96 overflow-y-auto pr-2">
                        <h4 class="text-lg font-semibold mb-3 text-white">Selecione (máx 8)</h4>
                        <div id="supplierCheckboxContainer" class="space-y-2">
                            <!-- Checkboxes serão injetados aqui via JS -->
                        </div>
                    </div>
                    <!-- Gráfico -->
                    <div class="lg:col-span-3 h-96">
                        <canvas id="supplierMonthlyCostChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Linha 5: Tabela de Sistemas -->
            <div class="glass-card animate-on-load" style="animation-delay: 1100ms;">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <div class="flex items-center gap-4"><h3 class="text-xl font-semibold">Todos os Sistemas</h3><button id="resetFilterBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-full text-sm transition-all">Mostrar Todos</button></div>
                    <!-- Controles de Filtro e Ordenação -->
                    <div class="flex flex-col sm:flex-row sm:justify-end gap-4 w-full sm:w-auto">
                        <!-- Seletor de Ordenação -->
                        <select id="sortCostSelect" class="w-full sm:w-auto bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-2 focus-outline-none focus:ring-2 focus:ring-green-500 text-white">
                            <option value="default">Ordenar por Padrão (Nome)</option>
                            <option value="cost_desc">Custo: Maior ao Menor</option>
                            <option value="cost_asc">Custo: Menor ao Maior</option>
                        </select>
                        <input type="text" id="searchInput" placeholder="Filtrar sistemas..." class="w-full sm:w-72 bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-2 focus-outline-none focus:ring-2 focus:ring-green-500 text-white">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-gray-600">
                            <tr class="text-white">
                                <th class="p-3">Fornecedor</th>
                                <th class="p-3">Sistema</th>
                                <th class="p-3">Departamento</th>
                                <th class="p-3">Tipo de Serviço</th>
                                <th class="p-3">Custo Anual (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="systemsTable"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Botão de Edição -->
    <button id="editModeToggle" class="fixed bottom-6 right-6 bg-green-600 hover:bg-green-500 text-white rounded-full p-4 shadow-lg transition-transform duration-300 hover:scale-110 focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    </button>

    <!-- Painel de Edição -->
    <aside id="editPanel" class="fixed top-0 right-0 h-full w-96 bg-gray-900/80 backdrop-blur-lg shadow-2xl p-6 overflow-y-auto z-50">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Modo Edição</h2>
            <button id="closeEditPanel" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        
        <div class="space-y-6">
            <div><label for="bgColorPicker" class="block text-sm font-medium text-white mb-2">Cor de Fundo</label><input type="color" id="bgColorPicker" class="w-full h-10 p-1 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer"></div>
            <div><label for="logoUploader" class="block text-sm font-medium text-white mb-2">Logo da Empresa</label><input type="file" id="logoUploader" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700"></div>
            
            <!-- Editor de Dados de Sistemas -->
            <div>
                <label for="dataEditor" class="block text-sm font-medium text-white mb-2">Dados de Sistemas (JSON)</label>
                <textarea id="dataEditor" rows="10" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm text-gray-300 font-mono focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                <p id="jsonErrorSystems" class="text-red-500 text-xs mt-1 hidden">JSON de Sistemas inválido!</p>
            </div>

            <!-- Editor de Dados de Custos -->
            <div>
                <label for="costDataEditor" class="block text-sm font-medium text-white mb-2">Dados de Custos (JSON)</label>
                <textarea id="costDataEditor" rows="10" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm text-gray-300 font-mono focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                <p id="jsonErrorCosts" class="text-red-500 text-xs mt-1 hidden">JSON de Custos inválido!</p>
            </div>

            <button id="saveChanges" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Guardar e Atualizar Dashboard</button>
        </div>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Estrutura de dados principal
            let appData = { 
                systems: [], 
                costs: {},
                companyLogo: '', 
                bgColor: '#2B652E',
                enrichedSystems: [] // Array para dados combinados
            };

            // Gráficos
            let departmentChart, vendorChart, monthlyCostChart, departmentCostChart, supplierMonthlyCostChart;
            let totalMonthlyCostData = []; // Armazena os dados totais para resetar
            let departmentColorMap = {}; // Mapa para cores consistentes por departamento
            const companyColors = ['#22c55e', '#84cc16', '#eab308', '#14b8a6', '#6366f1', '#ec4899', '#f97316', '#3b82f6'];
            const monthLabels = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
            let currentDeptFilter = null; // Armazena o filtro de departamento ativo

            // Dados Padrão
            const defaultData = {
                systems: [
                    { fornecedor: "ASSOCIATED SOFTWARE COMPANY LTDA", sistema: "Omnichannel", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Omnichannel" },
                    { fornecedor: "BEE2PAY TRAVEL SOLUTIONS S.A", sistema: "Travel Omnibees", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Sistema de Vendas" },
                    { fornecedor: "BENNER SISTEMAS SA", sistema: "Benner", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "ERP Benner" },
                    { fornecedor: "BUYSOFT DO BRASIL LTDA", sistema: "Azure", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Azure" },
                    { fornecedor: "DIGITRO TECNOLOGIA S.A.", sistema: "Digitro", departamento: "Infraestrutura e Suporte", modalidade: "Recorrente", tipo: "Central Telefonica" },
                    { fornecedor: "E-SOLUTION TECNOLOGIA E INOVACAO LTDA", sistema: "Mensalidade Sistema", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Mensalidade sistema" },
                    { fornecedor: "GUARDIAO DESENVOLVIMENTO DE SOFTWARES E MANUTENCAO DE COMPUTADORES E SISTEMAS", sistema: "GED Guardiao Digital", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "GED WAM" },
                    { fornecedor: "Lighthouse", sistema: "Lighthouse", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Sistema de reservas" },
                    { fornecedor: "NIARA SOLUCOES EM TECNOLOGIA LTDA", sistema: "Niara pay", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Sistema de motor de vendas" },
                    { fornecedor: "Pluspoint Inc.", sistema: "Plataforma de Gestao", departamento: "Governança de TI", modalidade: "Recorrente", tipo: "Sistema de gestão de reputação online" },
                    { fornecedor: "STARIAN SISTEMAS S/A", sistema: "Sienge", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "ERP Sienge" },
                    { fornecedor: "TIVIT TECNOLOGIA S/A", sistema: "SensorIT", departamento: "Governança de TI", modalidade: "Recorrente", tipo: "Sistema de governança de TI" },
                    { fornecedor: "UNE CONNECT LTDA", sistema: "Hotspot", departamento: "Infraestrutura e Suporte", modalidade: "Recorrente", tipo: "Sistema de Gestão Hot Spot" },
                    { fornecedor: "UNE CONNECT LTDA", sistema: "Cardapio Digital", departamento: "Infraestrutura e Suporte", modalidade: "Recorrente", tipo: "Sistema de Gestão Hot Spot" },
                    { fornecedor: "VVMDR ASSESSORIA EM TURISMO EIRELI", sistema: "Omnibees", departamento: "Sistemas e Dados", modalidade: "Recorrente", tipo: "Mensalidade sistema I.O." },
                    { fornecedor: "OpenAI", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "OpenAI" },
                    { fornecedor: "Antropic", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Antropic" },
                    { fornecedor: "Deep Seek", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Deep Seek" },
                    { fornecedor: "Google One + Gemini", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Google One + Gemini" },
                    { fornecedor: "Chat GPT Pró", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Chat GPT Pró" },
                    { fornecedor: "SUPABASE", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "SUPABASE" },
                    { fornecedor: "EVADESK LTDA", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Evadesk" },
                    { fornecedor: "MGC LTDA", sistema: "IA", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "MGC" },
                    { fornecedor: "SW SOLUCOES INTEGRADAS LTDA", sistema: "Banco de Dados", departamento: "Inovação e IA", modalidade: "Recorrente", tipo: "Cloud" },
                    { fornecedor: "Amazon AWS Serviços Brasil Ltda.", sistema: "Banco de dados AWS", departamento: "Infraestrutura e Suporte", modalidade: "Recorrente", tipo: "AWS" }
                ],
                costs: {
                    "ASSOCIATED SOFTWARE COMPANY LTDA": {"mensal": {"janeiro": 17898.31, "fevereiro": 18089.87, "março": 18216.03, "abril": 24863.02, "maio": 25287.14, "junho": 25015.95, "julho": 25631.86, "agosto": 23216.34, "setembro": 23973.76, "outubro": 25059.73, "novembro": 0.0}, "total_anual": 227252.01},
                    "Amazon AWS Serviços Brasil Ltda.": {"mensal": {"janeiro": 3810.54, "fevereiro": 5612.54, "março": 10203.05, "abril": 12334.75, "maio": 13618.21, "junho": 12106.67, "julho": 8882.03, "agosto": 9626.25, "setembro": 12158.02, "outubro": 0.0, "novembro": 0.0}, "total_anual": 88352.06},
                    "Antropic": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 488.89, "outubro": 0.0, "novembro": 0.0}, "total_anual": 488.89},
                    "BENNER SISTEMAS SA": {"mensal": {"janeiro": 8887.59, "fevereiro": 8887.59, "março": 8887.59, "abril": 8887.59, "maio": 8887.59, "junho": 10136.48, "julho": 8887.59, "agosto": 10135.33, "setembro": 9512.04, "outubro": 9512.04, "novembro": 0.0}, "total_anual": 92621.43},
                    "BUYSOFT DO BRASIL LTDA": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 70.07, "julho": 2533.59, "agosto": 14193.16, "setembro": 13462.83, "outubro": 20671.68, "novembro": 0.0}, "total_anual": 50931.33},
                    "Bee2Pay Travel Solutions S.a": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 7470.0, "outubro": 8943.0, "novembro": 0.0}, "total_anual": 16413.0},
                    "Chat GPT Pró": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 1146.0, "outubro": 0.0, "novembro": 0.0}, "total_anual": 1146.0},
                    "DIGITRO TECNOLOGIA S.A.": {"mensal": {"janeiro": 27682.84, "fevereiro": 27682.81, "março": 27682.85, "abril": 27682.85, "maio": 27682.85, "junho": 27682.85, "julho": 27682.85, "agosto": 27682.85, "setembro": 27802.16, "outubro": 27802.16, "novembro": 0.0}, "total_anual": 277067.07},
                    "Deep Seek": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 583.26, "outubro": 0.0, "novembro": 0.0}, "total_anual": 583.26},
                    "E-SOLUTION TECNOLOGIA E INOVACAO LTDA": {"mensal": {"junho": 202238.74, "setembro": 186201.62, "fevereiro": 204320.44, "agosto": 147930.29, "outubro": 186201.61, "abril": 204383.86, "novembro": 0.0, "maio": 204383.86, "janeiro": 197535.23, "julho": 196171.19, "março": 195445.92}, "total_anual": 1924812.76},
                    "EVADESK LTDA": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 1553.46, "outubro": 1553.46, "novembro": 0.0}, "total_anual": 3106.92},
                    "GUARDIAO DESENVOLVIMENTO DE SOFTWARES E MANUTENCAO DE COMPUTADORES E SISTEMAS": {"mensal": {"janeiro": 1412.0, "fevereiro": 1412.0, "março": 1412.0, "abril": 1412.0, "maio": 1412.0, "junho": 1412.0, "julho": 1412.0, "agosto": 1412.0, "setembro": 1412.0, "outubro": 1412.0, "novembro": 0.0}, "total_anual": 14120.0},
                    "GUARDIAO GESTAO DA INFORMACAO LTDA": {"mensal": {"janeiro": 14568.49, "fevereiro": 15368.22, "março": 15423.9, "abril": 15475.74, "maio": 15523.73, "junho": 15843.84, "julho": 14812.69, "agosto": 15918.71, "setembro": 15945.59, "outubro": 15974.4, "novembro": 0.0}, "total_anual": 154855.31},
                    "Google One + Gemini": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 99.0, "outubro": 0.0, "novembro": 0.0}, "total_anual": 99.0},
                    "Lighthouse": {"mensal": {"janeiro": 0.0, "fevereiro": 45083.38, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 0.0, "outubro": 0.0, "novembro": 0.0}, "total_anual": 45083.38},
                    "MGC LTDA": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 15000.0, "setembro": 15000.0, "outubro": 15000.0, "novembro": 0.0}, "total_anual": 45000.0},
                    "NIARA SOLUCOES EM TECNOLOGIA LTDA": {"mensal": {"janeiro": 12225.78, "fevereiro": 13200.0, "março": 13200.0, "abril": 12000.0, "maio": 12000.0, "junho": 0.0, "julho": 12000.0, "agosto": 12000.0, "setembro": 12417.31, "outubro": 12805.85, "novembro": 0.0}, "total_anual": 111848.94},
                    "OpenAI": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 13891.44, "outubro": 0.0, "novembro": 0.0}, "total_anual": 13891.44},
                    "Pluspoint Inc.": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 6676.2, "agosto": 5933.0, "setembro": 5428.8, "outubro": 0.0, "novembro": 0.0}, "total_anual": 18038.0},
                    "STARIAN SISTEMAS S/A": {"mensal": {"janeiro": 59002.16, "fevereiro": 59002.16, "março": 59002.16, "abril": 59002.16, "maio": 59002.16, "junho": 59002.16, "julho": 59002.16, "agosto": 59002.16, "setembro": 59002.16, "outubro": 53861.85, "novembro": 0.0}, "total_anual": 584881.29},
                    "SUPABASE": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 0.0, "agosto": 0.0, "setembro": 0.0, "outubro": 0.0, "novembro": 0.0}, "total_anual": 0.0},
                    "SW SOLUCOES INTEGRADAS LTDA": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 7000.0, "julho": 7000.0, "agosto": 7000.0, "setembro": 7000.0, "outubro": 7000.0, "novembro": 0.0}, "total_anual": 35000.0},
                    "TIVIT TECNOLOGIA S/A": {"mensal": {"janeiro": 0.0, "fevereiro": 0.0, "março": 0.0, "abril": 0.0, "maio": 0.0, "junho": 0.0, "julho": 12888.0, "agosto": 9999.0, "setembro": 9999.0, "outubro": 9999.0, "novembro": 0.0}, "total_anual": 42885.0},
                    "UNE CONNECT LTDA": {"mensal": {"janeiro": 14332.44, "fevereiro": 14576.44, "março": 14465.52, "abril": 14576.44, "maio": 14464.94, "junho": 14088.94, "julho": 3149.0, "agosto": 3037.8, "setembro": 3034.74, "outubro": 3036.26, "novembro": 0.0}, "total_anual": 98762.52},
                    "VVMDR ASSESSORIA EM TURISMO EIRELI": {"mensal": {"janeiro": 30600.0, "fevereiro": 30600.0, "março": 30600.0, "abril": 16800.0, "maio": 0.0, "junho": 7000.0, "julho": 7000.0, "agosto": 7000.0, "setembro": 7000.0, "outubro": 7000.0, "novembro": 0.0}, "total_anual": 143600.0}
                },
                companyLogo: "logo_empresa.jpeg",
                bgColor: '#2B652E'
            };

            // --- Funções Utilitárias ---
            const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            // Chave de normalização para lidar com "S.A" vs "S/A" vs "LTDA" etc.
            const normalizeKey = (str) => {
                if (typeof str !== 'string') return '';
                return str.toUpperCase()
                          .replace(/[\.,\/#!$%\^&\*;:{}=\-_`~()]/g,"") // Remove pontuação
                          .replace(/\sS A$/, "") // Remove " S A"
                          .replace(/\sLTDA$/, "") // Remove " LTDA"
                          .replace(/\sEIRELI$/, "") // Remove " EIRELI"
                          .replace(/\sSA$/, "") // Remove " SA"
                          .trim();
            };

            const aggregateData = (data, key) => data.reduce((acc, item) => { acc[item[key]] = (acc[item[key]] || 0) + 1; return acc; }, {});
            
            const animateCountUp = (el, end, duration = 1500, isCurrency = false) => {
                let start = 0, range = end - start, current = start, increment = end > start ? 1 : -1;
                
                const timer = setInterval(() => {
                    // Animação mais rápida
                    const step = Math.max(1, Math.ceil(Math.abs(end - current) * 0.05));
                    current += increment * step;

                    if ((increment > 0 && current > end) || (increment < 0 && current < end)) {
                        current = end;
                    }
                    
                    if(isCurrency) {
                        el.innerHTML = formatCurrency(current);
                    } else {
                        el.innerHTML = Math.ceil(current);
                    }
                    
                    if (current == end) clearInterval(timer);
                }, 20); // Intervalo menor para mais fluidez
            };

            // --- Funções de Persistência ---
            const saveState = () => { 
                try { 
                    const stateToSave = {
                        systems: appData.systems,
                        costs: appData.costs,
                        companyLogo: appData.companyLogo,
                        bgColor: appData.bgColor
                    };
                    localStorage.setItem('dashboardState', JSON.stringify(stateToSave)); 
                } catch (e) { console.error("Erro ao guardar no localStorage:", e); } 
            };
            
            const loadState = () => {
                const storedState = localStorage.getItem('dashboardState');
                if (storedState) {
                    const parsedState = JSON.parse(storedState);
                    appData = { ...defaultData, ...parsedState }; // Mescla, garantindo que todos os campos existam
                    
                    // Prevenção contra logos quebradas
                    if (appData.companyLogo && !appData.companyLogo.startsWith('data:image')) {
                        appData.companyLogo = defaultData.companyLogo;
                    }
                } else {
                    appData = JSON.parse(JSON.stringify(defaultData)); // Cópia profunda
                }
            };

            // --- Funções de Lógica de Dados ---
            const enrichSystemsData = () => {
                const { systems, costs } = appData;
                
                // 1. Criar um mapa de custos normalizado para busca rápida
                const costMap = new Map();
                for (const key in costs) {
                    costMap.set(normalizeKey(key), costs[key]);
                }

                // 2. Contar quantos sistemas cada fornecedor (normalizado) possui
                const supplierSystemCount = new Map();
                for (const system of systems) {
                    const normalizedFornecedor = normalizeKey(system.fornecedor);
                    supplierSystemCount.set(normalizedFornecedor, (supplierSystemCount.get(normalizedFornecedor) || 0) + 1);
                }

                // 3. Criar a array "enrichedSystems"
                appData.enrichedSystems = systems.map(system => {
                    const normalizedFornecedor = normalizeKey(system.fornecedor);
                    const costData = costMap.get(normalizedFornecedor);
                    const systemCount = supplierSystemCount.get(normalizedFornecedor) || 1; // Evita divisão por zero

                    let costAnual = 0;
                    let costMensal = {};

                    if (costData) {
                        // Divide o custo anual pelo número de sistemas desse fornecedor
                        costAnual = (costData.total_anual || 0) / systemCount;
                        
                        // Divide cada custo mensal
                        for(const month of monthLabels) {
                            costMensal[month] = (costData.mensal[month] || 0) / systemCount;
                        }
                    }

                    return {
                        ...system, // Copia todas as propriedades originais
                        costAnual: costAnual,
                        costMensal: costMensal
                    };
                });
            };

            // --- Funções de Renderização ---

            const applyStyling = () => {
                document.body.style.backgroundColor = appData.bgColor;
                document.getElementById('companyLogo').src = appData.companyLogo;
            };

            const renderTable = (dataToRender) => {
                const tableBody = document.getElementById('systemsTable');
                tableBody.innerHTML = dataToRender.length > 0 ? 
                    dataToRender.map(item => 
                        `<tr class="border-b border-gray-700/50 hover:bg-gray-800/50 transition-colors duration-200">
                            <td class="p-3">${item.fornecedor}</td>
                            <td class="p-3">${item.sistema}</td>
                            <td class="p-3">${item.departamento}</td>
                            <td class="p-3">${item.tipo}</td>
                            <td class="p-3">${formatCurrency(item.costAnual)}</td>
                        </tr>`
                    ).join('') : 
                    `<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhum sistema encontrado.</td></tr>`;
            };

            // Função centralizada para atualizar a tabela e gráficos dependentes
            const refreshTable = () => {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const sortValue = document.getElementById('sortCostSelect').value;

                let data;

                // 1. Get base data (completa ou filtrada por departamento)
                if (currentDeptFilter) {
                    data = appData.enrichedSystems.filter(item => item.departamento === currentDeptFilter);
                } else {
                    data = [...appData.enrichedSystems];
                }

                // 2. Filtrar por busca
                if (searchTerm) {
                    data = data.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)));
                }

                // 3. Ordenar
                if (sortValue === 'cost_desc') {
                    data.sort((a, b) => b.costAnual - a.costAnual);
                } else if (sortValue === 'cost_asc') {
                    data.sort((a, b) => a.costAnual - b.costAnual);
                } else {
                    // Padrão: ordenar por nome do fornecedor
                    data.sort((a, b) => (a.fornecedor || '').localeCompare(b.fornecedor || ''));
                }

                // 4. Renderizar a tabela
                renderTable(data);
                
                // 5. Atualizar gráficos que dependem desta filtragem (apenas os de contagem)
                updateVendorChart(data);
                updateDepartmentCostChart(data); // Gráfico de custo anual por depto também é filtrado
            }


            const renderAll = () => {
                // Destroi gráficos antigos
                if (departmentChart) departmentChart.destroy();
                if (vendorChart) vendorChart.destroy();
                if (monthlyCostChart) monthlyCostChart.destroy();
                if (departmentCostChart) departmentCostChart.destroy();
                if (supplierMonthlyCostChart) supplierMonthlyCostChart.destroy();
                
                // Combina os dados de sistemas e custos
                enrichSystemsData();
                
                const { systems, costs, enrichedSystems } = appData;

                applyStyling();

                // Gerar mapa de cores para departamentos
                departmentColorMap = {}; // Limpa o mapa
                const allDepartments = [...new Set(systems.map(s => s.departamento))].sort(); // Pega todos os deptos únicos e ordena
                allDepartments.forEach((dept, index) => {
                    departmentColorMap[dept] = companyColors[index % companyColors.length];
                });

                if (!systems || systems.length === 0) return;

                // --- Renderizar KPIs ---
                animateCountUp(document.getElementById('totalSistemas'), systems.length);
                animateCountUp(document.getElementById('totalFornecedores'), new Set(systems.map(i => i.fornecedor)).size);
                animateCountUp(document.getElementById('totalDepartamentos'), new Set(systems.map(i => i.departamento)).size);

                // --- Renderizar Gráficos de Contagem ---
                const departmentData = aggregateData(systems, 'departamento');
                const deptLabels = Object.keys(departmentData); // Pega os labels
                const deptColors = deptLabels.map(label => departmentColorMap[label]); // Mapeia para cores

                departmentChart = new Chart(document.getElementById('departmentChart').getContext('2d'), { 
                    type: 'doughnut', 
                    data: { 
                        labels: deptLabels, 
                        datasets: [{ 
                            data: Object.values(departmentData), 
                            backgroundColor: deptColors, 
                            borderColor: '#18181b' 
                        }] 
                    }, 
                    options: { responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#FFFFFF' } } } } 
                });
                
                const vendorData = aggregateData(systems, 'fornecedor');
                const sortedVendorData = Object.entries(vendorData).sort(([,a],[,b]) => b - a);
                vendorChart = new Chart(document.getElementById('vendorChart').getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: sortedVendorData.map(item => item[0]), 
                        datasets: [{ label: 'Nº de Sistemas', data: sortedVendorData.map(item => item[1]), backgroundColor: companyColors[0], borderWidth: 1, borderRadius: 4 }] 
                    }, 
                    options: { 
                        indexAxis: 'y', 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            x: { 
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                                ticks: { 
                                    color: '#FFFFFF', // CORREÇÃO: Cor do eixo X
                                    precision: 0,
                                    callback: (value) => Math.floor(value) === value ? value : null // Mostra apenas inteiros
                                } 
                            }, 
                            y: { 
                                grid: { display: false }, 
                                ticks: { color: '#FFFFFF' } 
                            } 
                        } 
                    } 
                });

                // --- Renderizar Gráficos de Custo ---

                // Gráfico 1: Evolução de Custo Mensal (Soma de todos os fornecedores)
                const monthlyCostData = monthLabels.map(month => {
                    return Object.values(costs).reduce((acc, item) => acc + (item.mensal[month] || 0), 0);
                });
                
                totalMonthlyCostData = [...monthlyCostData]; // Armazena uma cópia para resetar

                monthlyCostChart = new Chart(document.getElementById('monthlyCostChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: monthLabels.map(m => m.charAt(0).toUpperCase() + m.slice(1)), // Capitaliza
                        datasets: [{
                            label: 'Custo Mensal Total',
                            data: totalMonthlyCostData, // Usa a cópia global
                            borderColor: companyColors[0],
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' } }, // Legenda visível
                        scales: {
                            y: { 
                                ticks: { 
                                    color: '#FFFFFF', // CORREÇÃO: Cor do eixo Y
                                    callback: (value) => formatCurrency(value) 
                                } 
                            },
                            x: { ticks: { color: '#FFFFFF' } } // CORREÇÃO: Cor do eixo X
                        },
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                                }
                            }
                        }
                    }
                });

                // Gráfico 2: Custo Anual por Departamento (Baseado nos dados enriquecidos)
                updateDepartmentCostChart(enrichedSystems);

                // Renderizar gráfico de custo mensal por fornecedor
                populateSupplierCheckboxes();
                createEmptySupplierChart();

                // --- Renderizar Tabela ---
                currentDeptFilter = null; // Assegura que o filtro de depto está limpo
                document.getElementById('sortCostSelect').value = 'default'; // Assegura que o sort está no padrão
                document.getElementById('searchInput').value = ''; // Assegura que a busca está limpa
                refreshTable(); // Chama a função central para renderizar a tabela
                
                // Configura os event listeners
                setupDashboardEventListeners();
            };

            // --- Funções de Atualização Dinâmica ---

            // Atualiza o gráfico de linha de custo mensal (Total ou por Depto)
            const updateMonthlyCostChart = (departmentName = null) => {
                let dataToShow;
                let chartLabel;
                const chartTitleEl = document.getElementById('monthlyCostChartTitle');

                if (departmentName === null) {
                    // Reseta para o total
                    dataToShow = [...totalMonthlyCostData];
                    chartLabel = 'Custo Mensal Total';
                    chartTitleEl.innerText = 'Evolução de Custo Mensal';
                } else {
                    // Filtra por departamento
                    dataToShow = monthLabels.map(month => {
                        return appData.enrichedSystems
                            .filter(system => system.departamento === departmentName)
                            .reduce((acc, system) => acc + (system.costMensal[month] || 0), 0);
                    });
                    chartLabel = `Custo Mensal (${departmentName})`;
                    chartTitleEl.innerText = `Evolução de Custo Mensal (${departmentName})`;
                }

                if (monthlyCostChart) {
                    monthlyCostChart.data.datasets[0].data = dataToShow;
                    monthlyCostChart.data.datasets[0].label = chartLabel;
                    monthlyCostChart.update();
                }
            };

            // Atualiza o gráfico de barras (Sistemas por Fornecedor)
            const updateVendorChart = (data) => {
                const vendorData = aggregateData(data, 'fornecedor');
                const sortedVendorData = Object.entries(vendorData).sort(([,a],[,b]) => b - a);
                
                if (vendorChart) {
                    vendorChart.data.labels = sortedVendorData.map(item => item[0]);
                    vendorChart.data.datasets[0].data = sortedVendorData.map(item => item[1]);
                    vendorChart.update();
                }
            };

            // Atualiza o gráfico de rosca (Custo Anual por Departamento)
            const updateDepartmentCostChart = (data) => {
                const departmentCostData = data.reduce((acc, item) => {
                    acc[item.departamento] = (acc[item.departamento] || 0) + item.costAnual;
                    return acc;
                }, {});

                const sortedDepartmentCostData = Object.entries(departmentCostData).sort(([,a],[,b]) => b - a);

                const costLabels = sortedDepartmentCostData.map(item => item[0]);
                const costColors = costLabels.map(label => departmentColorMap[label] || '#cccccc'); // Mapeia para cores

                const chartData = {
                    labels: costLabels,
                    datasets: [{
                        data: sortedDepartmentCostData.map(item => item[1]),
                        backgroundColor: costColors,
                        borderColor: '#18181b'
                    }]
                };

                if (departmentCostChart) {
                    // Se o gráfico já existe, apenas atualiza os dados
                    departmentCostChart.data = chartData;
                    departmentCostChart.update();
                } else {
                    // Se não, cria um novo
                    departmentCostChart = new Chart(document.getElementById('departmentCostChart').getContext('2d'), {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            cutout: '60%',
                            onClick: (evt) => { // Evento de clique para filtrar
                                const points = departmentCostChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                                if (points.length) {
                                    const label = departmentCostChart.data.labels[points[0].index];
                                    updateMonthlyCostChart(label); // Filtra o gráfico de linha
                                    document.getElementById('resetFilterBtn').classList.remove('hidden'); // Mostra o botão de reset
                                }
                            },
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#FFFFFF' } },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const sum = context.chart.config.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = sum > 0 ? ((value / sum) * 100).toFixed(2) : 0;
                                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            };
            
            // --- Funções para o Comparador de Fornecedores ---

            // Popula a lista de checkboxes
            const populateSupplierCheckboxes = () => {
                const supplierContainer = document.getElementById('supplierCheckboxContainer');
                if (!supplierContainer) return;
                
                supplierContainer.innerHTML = ''; // Limpa
                const sortedSuppliers = Object.keys(appData.costs).sort();
                
                sortedSuppliers.forEach(supplierName => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const supplierId = `supplier-cb-${supplierName.replace(/[^a-zA-Z0-9]/g, '')}`; // Cria um ID seguro
                    div.innerHTML = `
                        <input id="${supplierId}" value="${supplierName}" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-green-500 focus:ring-green-600">
                        <label for="${supplierId}" class="ml-2 block text-sm text-white truncate" title="${supplierName}">${supplierName}</label>
                    `;
                    supplierContainer.appendChild(div);
                });

                // Adiciona o listener de evento no container pai
                supplierContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        updateSupplierMonthlyCostChart();
                    }
                });
            };

            // Cria o gráfico de fornecedor vazio na inicialização
            const createEmptySupplierChart = () => {
                if (supplierMonthlyCostChart) supplierMonthlyCostChart.destroy();
                
                const ctx = document.getElementById('supplierMonthlyCostChart').getContext('2d');
                supplierMonthlyCostChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthLabels.map(m => m.charAt(0).toUpperCase() + m.slice(1)), // Capitaliza
                        datasets: [] // Começa vazio
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { padding: 10, boxWidth: 10 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { 
                                    color: '#FFFFFF', // CORREÇÃO: Cor do eixo Y
                                    callback: (value) => formatCurrency(value) 
                                } 
                            },
                            x: { ticks: { color: '#FFFFFF' } } // CORREÇÃO: Cor do eixo X
                        },
                        interaction: { intersect: false, mode: 'index' },
                    }
                });
            };

            // Atualiza o gráfico de fornecedor com base nos checkboxes
            const updateSupplierMonthlyCostChart = () => {
                if (!supplierMonthlyCostChart) return;

                const checkedBoxes = document.querySelectorAll('#supplierCheckboxContainer input[type="checkbox"]:checked');
                const selectedSuppliers = Array.from(checkedBoxes).map(cb => cb.value);

                // Limita a 8 para legibilidade
                const limitedSuppliers = selectedSuppliers.slice(0, 8);
                
                // Desmarca visualmente os que passarem do limite
                if (selectedSuppliers.length > 8) {
                    Array.from(checkedBoxes).slice(8).forEach(cb => cb.checked = false);
                }

                const newDatasets = limitedSuppliers.map((supplierName, index) => {
                    const costData = appData.costs[supplierName];
                    const monthlyData = monthLabels.map(month => (costData && costData.mensal && costData.mensal[month]) ? costData.mensal[month] : 0);
                    return {
                        label: supplierName,
                        data: monthlyData,
                        borderColor: companyColors[index % companyColors.length],
                        backgroundColor: companyColors[index % companyColors.length] + '33', // Cor com transparência
                        fill: false,
                        tension: 0.3
                    };
                });

                supplierMonthlyCostChart.data.datasets = newDatasets;
                supplierMonthlyCostChart.update();
            };

            // --- Configuração de Event Listeners ---

            const populateEditPanel = () => {
                document.getElementById('bgColorPicker').value = appData.bgColor;
                document.getElementById('dataEditor').value = JSON.stringify(appData.systems, null, 2);
                document.getElementById('costDataEditor').value = JSON.stringify(appData.costs, null, 2); // Popula novo editor
            };

            const handleImageUpload = (file, callback) => { const reader = new FileReader(); reader.onload = e => callback(e.target.result); reader.readAsDataURL(file); };

            const setupDashboardEventListeners = () => {
                document.querySelectorAll('.glass-card').forEach(card => card.addEventListener('mousemove', e => { const rect = card.getBoundingClientRect(); card.style.setProperty('--x', `${e.clientX - rect.left}px`); card.style.setProperty('--y', `${e.clientY - rect.top}px`); }));
                
                // Filtro de Busca
                document.getElementById('searchInput').addEventListener('input', e => { 
                    if(currentDeptFilter) {
                        currentDeptFilter = null;
                        document.getElementById('resetFilterBtn').classList.add('hidden');
                        updateMonthlyCostChart(null); 
                    }
                    refreshTable();
                });

                // Clique no Gráfico de Depto (Contagem)
                document.getElementById('departmentChart').onclick = (evt) => { 
                    const points = departmentChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true); 
                    if (points.length) { 
                        const label = departmentChart.data.labels[points[0].index];
                        currentDeptFilter = label; // Define o filtro de depto
                        document.getElementById('searchInput').value = ''; // Limpa a busca
                        document.getElementById('sortCostSelect').value = 'default'; // Reseta o sort
                        document.getElementById('resetFilterBtn').classList.remove('hidden'); 
                        refreshTable(); // Atualiza a tabela e gráficos dependentes
                    } 
                };

                // Seletor de Ordenação
                document.getElementById('sortCostSelect').addEventListener('change', () => {
                    refreshTable();
                });

                // Botão Resetar Filtro
                document.getElementById('resetFilterBtn').onclick = () => { 
                    currentDeptFilter = null; // Limpa o filtro de depto
                    document.getElementById('searchInput').value = ''; // Limpa a busca
                    document.getElementById('sortCostSelect').value = 'default'; // Reseta o sort
                    document.getElementById('resetFilterBtn').classList.add('hidden'); 
                    updateMonthlyCostChart(null); // Reseta o gráfico de linha
                    refreshTable(); // Atualiza a tabela e gráficos dependentes
                };
            };

            const setupEditPanelEventListeners = () => {
                document.getElementById('editModeToggle').addEventListener('click', () => { document.getElementById('editPanel').classList.add('open'); populateEditPanel(); });
                document.getElementById('closeEditPanel').addEventListener('click', () => document.getElementById('editPanel').classList.remove('open'));
                document.getElementById('bgColorPicker').addEventListener('input', e => document.body.style.backgroundColor = e.target.value);
                document.getElementById('logoUploader').addEventListener('change', e => { if (e.target.files[0]) handleImageUpload(e.target.files[0], (base64) => document.getElementById('companyLogo').src = base64); });
                
                document.getElementById('saveChanges').addEventListener('click', () => {
                    let hasError = false;
                    
                    // Valida JSON de Sistemas
                    try { 
                        const newSystemsData = JSON.parse(document.getElementById('dataEditor').value); 
                        appData.systems = newSystemsData; 
                        document.getElementById('jsonErrorSystems').classList.add('hidden'); 
                    } catch (e) { 
                        document.getElementById('jsonErrorSystems').classList.remove('hidden'); 
                        hasError = true;
                    }
                    
                    // Valida JSON de Custos
                    try { 
                        const newCostsData = JSON.parse(document.getElementById('costDataEditor').value); 
                        appData.costs = newCostsData; 
                        document.getElementById('jsonErrorCosts').classList.add('hidden'); 
                    } catch (e) { 
                        document.getElementById('jsonErrorCosts').classList.remove('hidden'); 
                        hasError = true;
                    }

                    if (hasError) return; // Não salva se houver erro

                    appData.bgColor = document.getElementById('bgColorPicker').value;
                    appData.companyLogo = document.getElementById('companyLogo').src;
                    
                    saveState(); 
                    renderAll(); 
                    document.getElementById('editPanel').classList.remove('open');
                });
            };

            // --- Inicialização ---
            const init = () => { 
                loadState(); 
                renderAll(); 
                // setupDashboardEventListeners já é chamado dentro de renderAll
                setupEditPanelEventListeners();
            };
            
            init();
        });
    </script>
</body>
</html>

